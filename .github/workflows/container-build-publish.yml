# yamllint disable rule:truthy
---
name: Container Build & Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: Optional image tag override
        required: false
        default: ""
      push:
        description: Push image to Quay.io
        required: false
        type: boolean
        default: false
  pull_request:
    paths:
      - "Containerfile"
      - ".dockerignore"
      - "packaging/container/**"
      - "packaging/rpm/**"
      - "modulix-launcher"
      - ".github/workflows/container-build-publish.yml"

permissions:
  contents: read

jobs:
  build:
    name: Build container image
    runs-on: ubuntu-latest
    env:
      REGISTRY: quay.io

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Compute image name + tags
        shell: bash
        env:
          QUAY_NAMESPACE: ${{ vars.QUAY_NAMESPACE }}
        run: |
          set -euo pipefail

          repo="${GITHUB_REPOSITORY#*/}"
          image_repo="${repo#container-}"
          namespace="${QUAY_NAMESPACE:-${GITHUB_REPOSITORY_OWNER}}"
          image_name="${REGISTRY}/${namespace}/${image_repo}"

          push="false"
          tag=""

          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            push="true"
            tag="${{ github.event.release.tag_name }}"
          elif [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            push="${{ github.event.inputs.push || 'false' }}"
            tag="${{ github.event.inputs.tag || '' }}"
            if [[ -z "${tag}" ]]; then
              tag="manual-${GITHUB_SHA::12}"
            fi
          else
            pr_number="${{ github.event.pull_request.number }}"
            tag="pr-${pr_number}-${GITHUB_SHA::12}"
          fi

          case "${push}" in
            true|false) ;;
            *) echo "Invalid push value: ${push}" >&2; exit 1 ;;
          esac

          {
            echo "IMAGE_NAME=${image_name}"
            echo "IMAGE_TAG=${tag}"
            echo "PUSH_IMAGE=${push}"
            echo "IMAGE_TAGS<<EOF"
            echo "${image_name}:${tag}"
            if [[ "${push}" == "true" ]]; then
              echo "${image_name}:latest"
            fi
            echo "EOF"
          } >> "$GITHUB_ENV"

          echo "Using image ${image_name}:${tag} (push=${push})"

      - name: Validate Quay variables/secrets
        if: env.PUSH_IMAGE == 'true'
        shell: bash
        env:
          QUAY_NAMESPACE: ${{ vars.QUAY_NAMESPACE }}
          QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
          QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
        run: |
          set -euo pipefail

          fail=0

          if [ -z "${QUAY_NAMESPACE:-}" ]; then
            echo "::error::Missing required variable: vars.QUAY_NAMESPACE"
            fail=1
          fi

          if [ -z "${QUAY_USERNAME:-}" ]; then
            echo "::error::Missing required secret: secrets.QUAY_USERNAME"
            fail=1
          fi

          if [ -z "${QUAY_PASSWORD:-}" ]; then
            echo "::error::Missing required secret: secrets.QUAY_PASSWORD"
            fail=1
          fi

          if [ "$fail" -ne 0 ]; then
            exit 1
          fi

          echo "Quay configuration present (namespace + credentials)."

      - name: Set up QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Quay.io
        if: env.PUSH_IMAGE == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Build and optionally push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Containerfile
          push: ${{ env.PUSH_IMAGE == 'true' }}
          platforms: linux/amd64,linux/arm64
          tags: ${{ env.IMAGE_TAGS }}
